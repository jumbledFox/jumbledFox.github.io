<html>
    <head>
        <script src="/loadstyle.js"></script>

        <script>
            onload = function() {
                setup();
                // shamelessly stolen from https://github.com/rafgraph/spa-github-pages/blob/v6.0.0/index.html
                (function(l) {
                    if (l.search[1] === '/' ) {
                    var decoded = l.search.slice(1).split('&').map(function(s) { 
                        return s.replace(/~and~/g, '&')
                    }).join('?');
                    window.history.replaceState(null, null,
                        l.pathname.slice(0, -1) + decoded + l.hash
                    );
                    }
                }(window.location));

                let markdownfileLocation = "/markdownfiles" + ((window.location.pathname == "/") ? "/index" : window.location.pathname.replace(/\/$/, "")) + ".md";
                // Look for the markdown file
                fetch(window.location.origin  + markdownfileLocation).then(function(response) {
                    
                    let pagetorender = window.location.origin;

                    // Possible responses
                    switch(response.status) {
                        case 200:
                            // Found the file, so render it
                            break;
                        case 404:
                            // Didn't find the file, so render the 404 page
                            pagetorender = "/errorpages/404.md";
                            break;
                        default:
                            // Something else happened, so render the error page
                            pagetorender += "/errorpages/error.md";
                            break;
                    }

                    // Render the markdown file
                    if(pagetorender != window.location.origin) {
                        fetch(pagetorender).then(function(response) { renderpage(response);});
                    } else {
                        renderpage(response);
                    }
                });

                function renderpage(response) {
                    const md = new Remarkable({
                        html:true
                    });
                    
                    response.text().then(function(text) {
                        textsplit = text.split("<script id=\"markdownscript\"");
                        document.getElementById("main").innerHTML = md.render(textsplit[0]);
                        document.getElementById("main").innerHTML += "<script id=\"markdownscript\"" + textsplit[1];

                        eval(document.getElementById("markdownscript").innerHTML);
                    });
                }
            }
        </script>
    </head>
    <body>
        <div id="main"></div>
    </body>
</html>
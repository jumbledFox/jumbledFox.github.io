<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.jsdelivr.net/remarkable/1.7.1/remarkable.min.js"></script> <!-- Remarkable - markdown -->
        <script>
            window.onload = (function() {
                loadPage((window.location.search + window.location.hash).slice(2)
                .replace("&", "?").replace(/~and~/g, "&"));
            });

            function loadPage(l) {
                console.log("l:" + l);
                // l is the location of the markdown file, e.g. "index" or "about"
                var location = window.location.origin + "/pages/" + ((l == "") ? "index" : l) + ".md";
                console.log("location:" + location);
                // E.g. if l is "posts/post3", location is "https://jumbledFox.github.io/pages/posts/post3.md"
                // However if l is "", location is "https://jumbledFox.github.io/pages/index.md"

                // This checks if location exists, if it doesnt or some other error happens it brings up an error page
                fetch(location).then(function(response) {
                    console.log("Response: " + response.ok);
                    console.log("Response Status: " + response.status);
                    if(!response.ok) {
                        if (response.status == 404) {
                            // If the file doesn't exist, redirect to 404
                            location = window.location.origin + "/errorpages/404.md";
                        } else {
                            // Some other error...
                            location = window.location.origin + "/errorpages/othererror.md";
                        }
                    } else { }
                    console.log("location after:" + location);
                    
                    // This sets the url to the location and adds it to the history stack
                    /*
                    window.history.pushState(l, 
                        l.split("/").slice(-1)[0].split("-").map(
                            function(w) { return w[0].toUpperCase() +     w.substr(1)}
                            ).join(" "), // this makes "poo/wee/page-three" into "Page Three"
                        l);
                    */

                    // Then, delete everything in #main and load the markdown file
                    const md = new Remarkable({
                        html:true
                    });
                    
                    // TODO: This might not work, I'm not sure if it's the best way to do this
                    
                    fetch(location).then(function(response) {
                        response.text().then(function(text) {
                            document.getElementById("main").innerHTML = md.render(text);
                        });
                    });

                });

            }

            function interceptClick(event) {
                console.log("Clicked somewhere! " + event.path);
                if (event.path[0].nodename) { // if you clicked on an <a>
                    if (event.path[0].nodename.toLowerCase() == "a") {
                        console.log("Clicked on an <a>");
                        pagepath = event.path[0].href
                        if (pagepath.startsWith(window.location.origin)) {
                            console.log("Link internal, " + window.location.origin);
                            
                            // Link is internal - remove the origin
                            pagepath.slice(window.location.origin.length)
                            // Now if the link starts with "/" or is empty, load the page
                            if (pagepath.startsWith("/") || pagepath == "") {
                                console.log("It starts with / or is empty, loading page: " + pagepath);

                                loadPage(pagepath);
                                return false;
                            }
                        } else {
                            // Link is external, L + Ratio + Didn't ask
                        }
                    }
                }
            } document.onclick = interceptClick;


        </script>
    </head>
    <body>
        <div id="main"></div>
    </body>
</html>